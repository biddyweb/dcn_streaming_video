////////////////////////////////////////////////////////////////
/*
	File Name:		Client.h
	Instructor:		Prof. Arthur Goldberg
	Author:			Shen Li
	UID:			N14361265
	Department:		Computer Science
	Note:			This Client.h file includes
					HEADER FILES, MACRO, STRUCT DEFINITION,
					GLOBAL VARIABLE AND FUNCTION DECLARATION.
*/
////////////////////////////////////////////////////////////////

///////////////PRECOMPILER///////////////
#ifndef	CLIENT_H_
#define CLIENT_H_

///////////////DEBUG///////////////
#define DEBUG 1
#ifdef DEBUG
	#define DEBUG_PRINT		printf("%s-%s:%d:", __FILE__, __FUNCTION__, __LINE__)
	#define	DEBUG_START		fputs("/***********DEBUG INFORMATION***********/\n", stdout)
	#define DEBUG_END		fputs("/******************END******************/\n", stdout)
#else
	#define DEBUG_PRINT
	#define DEBUG_START
	#define DEBUG_END
#endif

///////////////HEADER FILES///////////////
#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <netdb.h>
#include <gtk/gtk.h>

///////////////MACRO///////////////
#define	CLIENT_RTP_PORT	25000
#define	WINDOW_TITLE	"Streaming Video Player"
#define	PROTOCOL_TYPE	"RTP/UDP"
#define	PROTOCOL_METHOD	"Compression"
#define	MY_NAME			"Shen Li"
#define	VIDEO_ICON		"Icon/video.png"
#define	SCREEN_NAME		"Icon/Screenshot"
#define	CRLF			"\r\n"

///////////////CONSTANTS VARIABLES///////////////
enum	widget_size_constants{	//widget size constants
	BORDER_WIDTH_SIZE	= 1,
	BOX_SPACING_SIZE	= 2,
	BOX_PADDING_SIZE	= 3,
	BUTTON_WIDTH_SIZE	= 60,
	BUTTON_LENGTH_SIZE	= 125,
	WINDOW_WIDTH_SIZE	= 500,
	WINDOW_LENGTH_SIZE	= 550,
};
enum	size_constants{			//size constants
	ONE_SIZE			= 1,
	NUMBER_SIZE 		= 4,
	RTP_HEAD_SIZE		= 12,
	HALFSTR_SIZE 		= 64,
	STRING_SIZE 		= 128,
	HALFBUF_SIZE 		= 512,
	BUFFER_SIZE 		= 1024,
	FRAME_SIZE			= 15360,
};
enum	color_constants{		//color constants
	RED_VALUE			= 62194,
	GREEN_VALUE			= 39578,
	BLUE_VALUE			= 30326,
};
enum	status_constants{		//rtsp client status constants
	INIT,
	READY,
	PLAYING,
};
enum	method_constants{		//rtsp method constants
	SETUP,
	PLAY,
	PAUSE,
	TEARDOWN,
};
enum	rtp_parameters{			//rtp parameters constants
	RTP_VERSION 		= 0x80,
	PADDING				= 0x00,
	EXTENSION			= 0x00,
	CSRC_COUNT			= 0x00,
	MARKER				= 0x00,
	PAYLOAD_TYPE		= 0x1a,
	RTP_VERSION_MASK	= 0xc0,
	PADDING_MASK		= 0x20,
	EXTENSION_MASK		= 0x10,
	CSRC_COUNT_MASK		= 0x0f,
	MARKER_MASK			= 0x80,
	PAYLOAD_TYPE_MASK	= 0x7f,
};

///////////////STRUCT DEFINITION///////////////
/*strcutre of type*/
typedef unsigned char	u_int8;
typedef unsigned short	u_int16;
typedef unsigned int	u_int32;
typedef short			int16;

/*structure of client data*/
typedef struct _client_data{
	GtkWidget		*window;		//window widget
	const gchar		*host;			//server ip address/name
	const gchar		*service;		//server port/service
	const gchar		*video;			//server port/service
}CLIENT_DATA;

/*structure of rtsp response header message*/
typedef struct _rtsp_header{
	char	field_name[HALFSTR_SIZE];		//field name
	char	field_value[HALFBUF_SIZE];		//field value
	struct _rtsp_header *next;				//next pointer
}RTSP_HEADER;

/*structure of rtp packet header*/
typedef struct _rtp_header{
	u_int8		vpxcc;						//rtp parameter: version, padding, extension, and csrc count
	u_int8		mpt;						//rtp parameter: marker, payload type
	u_int16		seq_number;					//sequence number field
	u_int32		timestamp;					//timestamp field
	u_int32		ssrc;						//ssrc field
}RTP_HEADER;

///////////////GLOBAL VARIABLE///////////////
GtkWidget	*toolbar;			//toolbar widget
GtkWidget	*image;				//image widget
GtkWidget	*setupButton;		//setup button widget
GtkWidget	*playButton;		//play button widget
GtkWidget	*pauseButton;		//pause button widget
GtkWidget	*teardownButton;	//teardown button widget
u_int32		session_id;			//seesion id number
u_int32		cseq_number;		//cseq number
u_int32		status;				//client status
int			client_rtp_port;	//client rtp port number
int			client_rtcp_port;	//client rtcp port number
int			server_rtp_port;	//server rtp port number

///////////////FUNCTION DECLARATION///////////////
/*DieWithMessage.c*/
void	dieWithUserMessage(const char *message, const char *detail);
void	dieWithSystemMessage(const char *message);
/*ClientUtility.c*/
void	initClient(int port);
int		setupClientTCPSocket(const char *host, const char *service);
int		setupClientUDPSocket(const char *service);
/*AddressUtility.c*/
void	printSocketAddress(const struct sockaddr *address, FILE *stream);
/*HandleUtility.c*/
bool	handleServerResponse(GtkWidget *widget, int client_socket);
RTSP_HEADER		*getHeaderLines(FILE *stream);
char	*getResponseContents(FILE *stream);
/*RTPPacketUtility.c*/
void	startRTPProgress(CLIENT_DATA *client_data);
void	stopRTPProgress(u_int32 status_signal);
bool	checkRTPHeader(const u_int8 *rtp);
void	SIGIOHandler(int signal);
/*LayoutUtility.c*/
void	initClientLayout(GtkWidget *window);
GtkWidget	*getMenubarMenu(GtkWidget *window);
GtkWidget	*getToolbar();
GtkWidget	*getButton(	GtkWidget 	*box,
						const gchar *icon_name,
						const gchar *label_string,
						const gchar *tooltip_label);
void	setSensitive(	gboolean setup_s,
						gboolean play_s,
						gboolean pause_s,
						gboolean teardown_s);
void	setImage(const u_int8 *rtp);
GdkPixbuf	*getIcon(const gchar *icon_name);
/*CallbackUtility.c*/
void	initCallback(CLIENT_DATA *client_data);
void	menuCallback(	gpointer	callback_data,
						guint		callback_action,
						GtkWidget	*menu_item);
void	setupRTSPCallback(GtkWidget *widget, CLIENT_DATA *client_data);
void	playRTSPCallback(GtkWidget *widget, CLIENT_DATA *client_data);
void	pauseRTSPCallback(GtkWidget *widget, CLIENT_DATA *client_data);
void	teardownRTSPCallback(GtkWidget *widget, CLIENT_DATA *client_data);
void	showToolbar(	gpointer	callback_data,
						guint		callback_action,
						GtkWidget	*menu_item);
void	showAboutCallback(GtkWidget *widget, gpointer data);
void	showInfoCallback(GtkWidget *widget, gpointer data);
void	showErrorCallback(GtkWidget *widget, gpointer data);
void	showQuesCallback(GtkWidget *widget, gpointer data);
void	showWarnCallback(GtkWidget *widget, gpointer data);
void	enterButtonCallback(GtkWidget *widget, gpointer data);
void	deleteEventCallback(GtkWidget	*widget,
							GdkEvent	*event,
							gpointer	data);
/*StringUtility.c*/
char	*itoa(int number);
bool	fieldExist(RTSP_HEADER *header, const char *field_name, char *field_value);
char	*splitNameAndValue(char *header_line, const char stop);

#endif //CLIENT_H
